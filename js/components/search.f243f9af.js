import{status,initFlashcardHover,randomAnime}from"./initializer.7173126f.js";import{searchAnime,getTopRatedAnime,getMostPopularAnime,getGenres,genres}from"../api.4d58ec19.js";import{createSection,createFlashcard}from"./UIs.76afe8ca.js";import{loadCSS,showLoader,hideLoader}from"../pages.99567a16.js";const activeFilters={};export async function loadSearchPage(){const e=window.location.hash;loadCSS("./css/search.e2667b0c.css"),console.log("Loading Search Page"),document.getElementById("navsearch").style.color="#8960ff",document.getElementById("navhome").style.color="#ddd","{}"===JSON.stringify(genres)&&getGenres();document.getElementById("content").innerHTML='\n    <h1 class="search-title">Search across our databases and make your pick!</h1>\n    <div class="search-container">\n        <div class="search-bar">\n            <button class="filter-button"><i class="fas fa-filter"></i> Filters</button>\n            <div class="search-bar-content">\n                <input type="text" id="search-input" placeholder="Search for anime...">\n                <button id="search-button"><i class="fas fa-search"></i></button>\n            </div>\n        </div>\n        <div class="filter-options" style="display: none;">\n            <h2 class=\'filter-title\'>Filter Options</h2>\n            <div class="filter-section">\n                <div class="filter-controls">\n                    <h4 class="filter-header">Type:</h4>\n                    <div class="filter-buttons">\n                        <button class="filter-btn" data-filter="type" data-value="tv">TV</button>\n                        <button class="filter-btn" data-filter="type" data-value="movie">Movie</button>\n                        <button class="filter-btn" data-filter="type" data-value="ova">OVA</button>\n                        <button class="filter-btn" data-filter="type" data-value="special">Special</button>\n                        <button class="filter-btn" data-filter="type" data-value="ona">ONA</button>\n                        <button class="filter-btn" data-filter="type" data-value="music">Music</button>\n                    </div>\n                </div>\n            </div>\n            <div class="filter-section">\n                <div class="filter-controls">\n                    <h4 class="filter-header">Status:</h4>\n                    <div class="filter-buttons">\n                        <button class="filter-btn" data-filter="status" data-value="airing">Airing</button>\n                        <button class="filter-btn" data-filter="status" data-value="complete">Completed</button>\n                        <button class="filter-btn" data-filter="status" data-value="upcoming">Upcoming</button>\n                    </div>\n                </div>\n            </div>\n            <div class="filter-section">\n                <div class="filter-controls">\n                    <h4 class="filter-header">Rating:</h4>\n                    <div class="filter-buttons">\n                        <button class="filter-btn" data-filter="rating" data-value="g">G - All Ages</button>\n                        <button class="filter-btn" data-filter="rating" data-value="pg">PG - Children</button>\n                        <button class="filter-btn" data-filter="rating" data-value="pg13">PG-13 - Teens 13+</button>\n                        <button class="filter-btn" data-filter="rating" data-value="r17">R - 17+ (violence)</button>\n                        <button class="filter-btn" data-filter="rating" data-value="r">R+ - Mild Nudity</button>\n                        <button class="filter-btn" data-filter="rating" data-value="rx">Rx - Hentai</button>\n                    </div>\n                </div>\n            </div>\n            <div class="filter-section">\n                <div class="filter-controls">\n                    <h4 class="filter-header">Score:</h4>\n                    <input type="number" class="filter-input" placeholder="Min Score" id="min_score" min="0" max="10" step="0.1">\n                    <input type="number" class="filter-input" placeholder="Max Score" id="max_score" min="0" max="10" step="0.1">\n                </div>\n            </div>\n            <div class="filter-section">\n                <div class="filter-controls">\n                    <h4 class="filter-header">Season:</h4>\n                    <div class="filter-buttons">\n                        <button class="filter-btn" data-filter="season" data-value="winter">Winter</button>\n                        <button class="filter-btn" data-filter="season" data-value="spring">Spring</button>\n                        <button class="filter-btn" data-filter="season" data-value="summer">Summer</button>\n                        <button class="filter-btn" data-filter="season" data-value="fall">Fall</button>\n                    </div>\n                </div>\n            </div>\n            <div class="filter-section">\n                <h4 class="filter-header">Genres:</h4>\n                <div class= "filter-buttons" id="genresDiv">\n                </div>\n            </div>\n            <div class="filter-section">\n                <div class="filter-controls">\n                    <h4 class="filter-header">Order By:</h4>\n                    <select id="order_by" class="filter-dropdown">\n                        <option value="score">Score</option>\n                        <option value="members">Members</option>\n                        <option value="popularity">Popularity</option>\n                        <option value="title">A-Z</option>\n                        <option value="favorites">Favorites</option>\n                        <option value="episodes">Episodes</option>\n                    </select>\n                    <h4 class="filter-header">Sort Direction:</h4>\n                    <select id="sort" class="filter-dropdown">\n                        <option value="desc">Descending</option>\n                        <option value="asc">Ascending</option>\n                    </select>\n                </div>\n            </div>\n            <div class="sfw-toggle">\n                <label class="switch">\n                    <input type="checkbox" id="sfw-checkbox" checked>\n                    <span class="slider round"></span>\n                </label>\n                <span>Allow NSFW content</span>\n            </div>\n        </div>\n    </div>\n    <div id="search-results"></div>\n    ',showLoader(),initFilters(),initSearch(),renderGenres();const[t,n]=e.split("?");if("#/search"!==t||n)console.log(`Search initiated with query: ${n}`);else{const t=await searchAnime("https://api.jikan.moe/v4/anime?page=1");if("#/search"!==e)return;displaySearchResults(t);const n=document.getElementById("search-results");if(n){if("#/search"!==e)return;const t=await createSection({title:"Top Rated Anime",apiFunction:getTopRatedAnime,cardType:"top-rated",containerClass:"airing-container",titleClass:"airing-title",galleryClass:"gridGallery"});if("#/search"!==e)return;if(n.insertAdjacentHTML("beforeend",t),"#/search"!==e)return;const a=await createSection({title:"Most Popular Anime",apiFunction:getMostPopularAnime,cardType:"most-popular",containerClass:"airing-container",titleClass:"airing-title",galleryClass:"gridGallery"});if("#/search"!==e)return;n.insertAdjacentHTML("beforeend",a)}"#/search"===e&&(initFlashcardHover(),document.getElementById("randomDiv").style.display="block",randomAnime(),hideLoader())}}function loadPagination(e,t){if(!t)return;t.innerHTML="";const{current_page:n,last_visible_page:a,has_next_page:i}=e,s=(e,t,n)=>{const a=document.createElement("button");return a.innerHTML=e,a.disabled=!n,n&&a.addEventListener("click",()=>{const e=getSafeParams();e.set("page",t);const n=`#/search?${e.toString()||`page=${t}`}`;window.location.hash=n}),a};t.appendChild(s("<<",1,n>1)),t.appendChild(s("<",n-1,n>1));const r=document.createElement("span");r.textContent=n,t.appendChild(r),t.appendChild(s(">",n+1,i)),t.appendChild(s(">>",a,n<a))}export async function displaySearchResults(e){const t=document.getElementById("search-results");if(!t)return;if(t.innerHTML="",!e?.data?.length)return t.innerHTML='<p class="no-results">No Matching results found.</p>',status.searching=!1,void hideLoader();const n=document.createElement("h2");n.className="search-results-info",n.textContent=`Found ${e.pagination.items.total} anime in database`,t.appendChild(n);const a=document.createElement("div");a.className="gridGallery",a.innerHTML=e.data.map(e=>createFlashcard(e,"top-rated")).join(""),t.appendChild(a);const i=document.createElement("div");i.className="pagination-controls",t.appendChild(i),initFlashcardHover(),loadPagination(e.pagination,i)}export async function initSearch(){const e=getSafeParams();for(const e in activeFilters)delete activeFilters[e];for(const[t,n]of e.entries())activeFilters[t]="genres"===t?n.split(","):n;applyFilters();const t=document.getElementById("search-button");t&&t.addEventListener("click",()=>{delete activeFilters.page,constructURL(!0)});const n=document.getElementById("search-input");n.addEventListener("input",()=>{activeFilters.q=n.value}),n.addEventListener("keypress",e=>{"Enter"===e.key&&(delete activeFilters.page,constructURL(!0))}),e.toString()&&handleSearch(!1)}async function handleSearch(e=!0){const t=await constructURL(e),n=document.getElementById("search-results");if(n&&(n.innerHTML='<div class="loader" style="display: flex; justify-content: center; align-items: center; width:100%;">\n                            <div class="dot"></div>\n                            <div class="dot"></div>\n                            <div class="dot"></div>\n                         </div>',t)){displaySearchResults(await searchAnime(t))}}export async function constructURL(e=!1){const t=new URLSearchParams;for(const e in activeFilters){let n=activeFilters[e];"q"===e&&(n=n.replace(/[^\p{L}\p{N}\s\-_.:'"|#]/gu,"").slice(0,100)),Array.isArray(n)?t.append(e,n.join(",")):t.append(e,n)}if(!t.toString())return null;const n=`https://api.jikan.moe/v4/anime?${t.toString()}`;return e&&(window.location.hash=`#/search?${t.toString()}`),n}export function applyFilters(){document.querySelectorAll('[class*="active"]').forEach(e=>e.classList.remove("active"));const e=["order_by","sort","min_score","max_score"];for(const t in activeFilters){const n=activeFilters[t];if("q"===t){const e=document.getElementById("search-input");e&&(e.value=n)}else if("genres"===t)n.forEach(e=>{const n=document.querySelector(`[data-filter='${t}'][data-value='${e}']`);n&&n.classList.add("active")});else if("page"===t);else if("sfw"===t){const e=document.getElementById("sfw-checkbox");e&&(e.checked=!1)}else if(e.includes(t)){const e=document.getElementById(t);e&&(e.value=n)}else{const e=document.querySelector(`[data-filter='${t}'][data-value='${n}']`);e&&e.classList.add("active")}}}export function initFilters(){const e=document.querySelector(".filter-button"),t=document.querySelector(".filter-options"),n=document.querySelectorAll(".filter-btn"),a=document.querySelectorAll(".filter-input"),i=document.querySelectorAll(".filter-dropdown");e.addEventListener("click",()=>{t.style.display="none"===t.style.display?"grid":"none"}),n.forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.filter,n=e.dataset.value;["season","status","type","rating"].includes(t)?(document.querySelectorAll(`.filter-btn[data-filter="${t}"]`).forEach(e=>e.classList.remove("active")),activeFilters[t]!==n?(activeFilters[t]=n,e.classList.add("active")):delete activeFilters[t]):activeFilters[t]&&activeFilters[t].includes(n)?(activeFilters[t]=activeFilters[t].filter(e=>e!==n),activeFilters[t].length||delete activeFilters[t],e.classList.remove("active")):(activeFilters[t]||(activeFilters[t]=[]),activeFilters[t].push(n),e.classList.add("active"))})}),a.forEach(e=>{e.addEventListener("input",()=>{const t=e.id,n=e.value;n?activeFilters[t]=n:delete activeFilters[t]})}),i.forEach(e=>{e.addEventListener("change",()=>{const t=e.id,n=e.value;n?activeFilters[t]=n:delete activeFilters[t]})});const s=document.getElementById("sfw-checkbox");s.addEventListener("change",()=>{s.checked&&activeFilters.sfw?(delete activeFilters.sfw,s.checked=!0):(activeFilters.sfw="true",s.checked=!1)})}export async function renderGenres(){"{}"===JSON.stringify(genres)&&await getGenres();const e=Object.entries(genres).map(([e,t])=>`\n        <button class="genre-btn" data-filter="genres" data-value="${e}">${t}</button>\n    `).join("");document.getElementById("genresDiv").innerHTML+=e,document.querySelectorAll(".genre-btn").forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.filter,n=e.dataset.value;activeFilters[t]&&activeFilters[t].includes(n)?(activeFilters[t]=activeFilters[t].filter(e=>e!==n),activeFilters[t].length||delete activeFilters[t],e.classList.remove("active")):(activeFilters[t]||(activeFilters[t]=[]),activeFilters[t].push(n),e.classList.add("active"))})}),applyFilters()}const allowed_filters=new Set(["q","page","genres","min_score","max_score","status","type","rating","order_by","sort","sfw"]),ENUMS={status:new Set(["airing","complete","upcoming"]),type:new Set(["tv","movie","ova","special"]),rating:new Set(["g","pg","pg13","r","r17","rx"]),order_by:new Set(["title","score","popularity","favorites","members","episodes"]),sort:new Set(["asc","desc"])};export function getSafeParams(){const e=new URLSearchParams(window.location.hash.split("?")[1]||"");console.log(`raw : ${e}`);const t=new URLSearchParams;for(const[n,a]of e.entries())if(allowed_filters.has(n))if("q"===n){const e=a.replace(/[^\p{L}\p{N}\s\-_.:'";|#]/gu,"").slice(0,100);t.set("q",e)}else if(["min_score","max_score"].includes(n)){const e=parseInt(a,10);Number.isFinite(e)&&e>=0&&e<=10&&t.set(n,String(e))}else if("page"===n){const e=parseInt(a,10);Number.isFinite(e)&&e>=1&&e<=1e3&&t.set(n,String(e))}else if("genres"===n){const e=a.split(",").map(e=>parseInt(e,10)).filter(e=>Number.isFinite(e)&&e>0);e.length&&t.set("genres",e.join(","))}else if("sfw"===n)t.set("sfw",a);else if(ENUMS[n]){const e=a.toLowerCase();ENUMS[n].has(e)&&t.set(n,e)}return console.log(`safe : ${t}`),t}