import{getAnimeDetails,getAnimeCharacters,getAnimeStaff,getAnimeInfo,getRandomAnime,getAnimeReviews}from"../api.c847ee31.js";import{initFlashcardHover,initGalleryControls}from"../main.84fb288e.js";import{showLoader,hideLoader,loadCSS,load404}from"../pages.669bc5c1.js";import{createFlashcard}from"./UIs.c6db23a0.js";import{escapeHTML}from"./utils.af173b93.js";export async function loadDetailsPage(e=null){console.log(`Loading Details for anime ID: ${e}`),loadCSS("./css/details.3b3ddace.css"),document.getElementById("navhome").style.color="#ddd",document.getElementById("navsearch").style.color="#ddd";const a=document.getElementById("content");a.innerHTML="",document.getElementById("randomDiv").style.display="none";const n=document.createElement("link");n.rel="preload",n.href="./media/details-bg.webp",n.as="image",n.type="image/webp",document.head.appendChild(n),showLoader();try{const n="random"===e,s=n?await getRandomAnime():await getAnimeDetails(e);if(!s||!s.mal_id)throw new Error("Anime data not found.");const i=`#/details-${e=s.mal_id}`;n&&history.replaceState(null,null,i);const t=[...(s.title_synonyms||[]).map(e=>`<li>${e}</li>`),...(s.titles||[]).map(e=>`<li>${e.type}: ${e.title}</li>`)].join(""),l=s.genres&&s.genres.length>0?`\n        <div class="details-genres-inner">\n            <h2 class="genres-header">Genres</h2>\n            <div class="details-genres-list">\n                ${s.genres.map(e=>`<span class="genre-tag">${e.name}</span>`).join("")}\n            </div>\n        </div>\n      `:"",c=s.season?`${s.season.charAt(0).toUpperCase()+s.season.slice(1)}`:"N/A",o=s.year||"N/A";let r=s.trailer?.embed_url?.replace("&autoplay=1","").replace("?autoplay=1","")+"&modestbranding=1&showinfo=0&rel=0";const d=r?`\n        <div class="details-trailer">\n            <h2>Trailer</h2>\n            <div class="trailer-container">\n              <iframe\n                  loading="lazy"\n                  src="${r}"\n                  frameborder="0"\n                  allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"\n                  allowfullscreen>\n              </iframe>\n            </div>\n        </div>\n        `:"",v='<div class="loader"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>',p=`\n        <div class="details-stats hero-stats">\n            <div class="stat-box">\n                <h3>Score</h3>\n                <p class="stat-value-large">${s.score?`‚≠ê ${s.score}`:"N/A"}</p>\n            </div>\n            <div class="stat-box">\n                <h3>Popularity</h3>\n                <p class="stat-value-large">#${s.popularity||"N/A"}</p>\n            </div>\n            <div class="stat-box">\n                <h3>Members</h3>\n                <p class="stat-value-large">${s.members?.toLocaleString()||"N/A"}</p>\n            </div>\n            <div class="stat-box">\n                <h3>Rank</h3>\n                <p class="stat-value-large">#${s.rank||"N/A"}</p>\n            </div>\n        </div>\n    `,m=`\n      <div class="details-genres-inner">\n          <h2 class="genres-header">Producers</h2>\n          <div class="details-genres-list">\n              ${s.producers&&s.producers.length>0?s.producers.map(e=>`<span class="genre-tag">${e.name}</span>`).join(""):'<span class="genre-tag is-na">N/A</span>'}\n          </div>\n      </div>\n      <div class="details-genres-inner">\n          <h2 class="genres-header">Licensors</h2>\n          <div class="details-genres-list">\n              ${s.licensors&&s.licensors.length>0?s.licensors.map(e=>`<span class="genre-tag">${e.name}</span>`).join(""):'<span class="genre-tag is-na">N/A</span>'}\n          </div>\n      </div>\n      <div class="details-genres-inner">\n          <h2 class="genres-header">Studios</h2>\n          <div class="details-genres-list">\n              ${s.studios&&s.studios.length>0?s.studios.map(e=>`<span class="genre-tag">${e.name}</span>`).join(""):'<span class="genre-tag is-na">N/A</span>'}\n          </div>\n      </div>\n      <div class="themes-section">\n          <h4>Opening Themes</h4>\n          <ul>${s.theme?.openings&&s.theme.openings.length>0?s.theme.openings.map(e=>`<li>${e}</li>`).join(""):"<li>No opening themes found.</li>"}</ul>\n          <h4>Ending Themes</h4>\n          <ul>${s.theme?.endings&&s.theme.endings.length>0?s.theme.endings.map(e=>`<li>${e}</li>`).join(""):"<li>No ending themes found.</li>"}</ul>\n      </div>\n      <div class="links-section">\n          <div class="external-links">\n              <h4>External Links</h4>\n              <div class="links-container">\n                  ${s.external&&s.external.length>0?s.external.map(e=>`<a href="${e.url}" target="_blank" class="link-button"><i class="fa-solid fa-arrow-up-right-from-square"></i>${e.name}</a>`).join(""):"<p>No external links available.</p>"}\n              </div>\n          </div>\n          <div class="streaming-platforms">\n              <h4>Streaming Platforms</h4>\n              <div class="links-container">\n                  ${s.streaming&&s.streaming.length>0?s.streaming.map(e=>`<a href="${e.url}" target="_blank" class="link-button"><i class="fas fa-play-circle"></i>${e.name}</a>`).join(""):"<p>No streaming links available.</p>"}\n              </div>\n          </div>\n      </div>\n    `,f='<div class="loader"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>',h=f,u='\n      <div class="reviews-container">\n        <div class="gallery-prev">&lt</div>\n        <div class="gallery-next">&gt</div>\n        <h2 class="floating-header">What People Have to Say</h2>\n        <div class="loader" id="reviews-loader">\n          <div class="dot"></div>\n          <div class="dot"></div>\n          <div class="dot"></div>\n        </div>\n      </div>\n    ',g=`\n      <div class="details-hero-wrapper">\n        <h1>${s.title_english||s.title}</h1>\n        <div class="details-hero">\n          <div class="details-poster-group">\n            <div class="details-poster">\n              <img src="${s.images?.webp?.large_image_url||s.imagea?.jpg?.large_image_url}" alt="${s.title||"No Title"}" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"/>\n              <div class="placeholder-icon" style="display: none;"><i class="fas fa-question-circle"></i></div>\n            </div>\n          </div>\n          <div class="details-info">\n            ${p}\n            <h2 class="synopsis-header">Synopsis</h2>\n            <p class="details-synopsis">${escapeHTML(s.synopsis||"No synopsis available.")}</p>\n          </div>\n        </div>\n      </div>\n      <div class="details-container">\n        <div class="quick-facts-table">\n            <div class="fact-item"><span class="fact-label">Type:</span><span class="fact-value">${s.type||"N/A"}</span></div>\n            <div class="fact-item"><span class="fact-label">Episodes:</span><span class="fact-value">${s.episodes||"N/A"}</span></div>\n            <div class="fact-item"><span class="fact-label">Status:</span><span class="fact-value">${s.status||"N/A"}</span></div>\n            <div class="fact-item"><span class="fact-label">Aired:</span><span class="fact-value">${s.aired?.string||"N/A"}</span></div>\n            <div class="fact-item"><span class="fact-label">Season:</span><span class="fact-value">${c}</span></div>\n            <div class="fact-item"><span class="fact-label">Year:</span><span class="fact-value">${o}</span></div>\n            <div class="fact-item"><span class="fact-label">Rating:</span><span class="fact-value">${s.rating||"N/A"}</span></div>\n            <div class="fact-item"><span class="fact-label">Source:</span><span class="fact-value">${s.source||"N/A"}</span></div>\n            <div class="fact-item"><span class="fact-label">Scored By:</span><span class="fact-value">${s.scored_by?.toLocaleString()||"N/A"}</span></div>\n            <div class="fact-item"><span class="fact-label">Duration:</span><span class="fact-value">${s.duration||"N/A"}</span></div>\n            <div class="fact-item"><span class="fact-label">Favorites:</span><span class="fact-value">${s.favorites?.toLocaleString()||"N/A"}</span></div>\n            <div class="fact-item"><span class="fact-label">Official Source:</span><span class="fact-value"><a href="${s.url||"#"}" target="_blank" class="source-link">MyAnimeList</a></span></div>\n        </div>\n\n        <nav class="details-nav">\n          <div class="details-nav-item active" data-target="overview">Overview</div>\n          <div class="details-nav-item" data-target="relations">Relations</div>\n          <div class="details-nav-item" data-target="production">Production</div>\n          <div class="details-nav-item" data-target="characters">Characters</div>\n          <div class="details-nav-item" data-target="staff">Staff</div>\n        </nav>\n\n        <div id="overview" class="details-section active">\n            <div class="details-titles-box">\n              <h2>Also Known As: </h2>\n              <ul class="titles-list">${t}</ul>\n            </div>\n            ${l}\n            <h2 class="floating-header">Background</h2>\n            <p>${s.background||"No background information available."}</p>\n        </div>\n\n        <div id="relations" class="details-section">\n          <div id="relations-container">\n            ${v}\n          </div>\n        </div>\n\n        <div id="production" class="details-section">\n          ${m}\n        </div>\n\n        <div id="characters" class="details-section">\n          ${f}\n        </div>\n\n        <div id="staff" class="details-section">\n          ${h}\n        </div>\n        ${u}\n        ${d}\n      </div>\n    `;window.location.hash===i&&(a.innerHTML=g,initDetailsNav(),loadReviews(e),loadCharecters(e),loadStaff(e),loadRelations(s.relations,e))}catch(a){console.error("Failed to load anime details:",a),load404(`details-${e}`)}finally{window.location.hash===`#/details-${e}`&&(hideLoader(),document.getElementById("randomDiv").style.display="none")}}async function loadRelations(e,a){const n=document.getElementById("relations-container");if(!e||0===e.length)return void(n&&(n.innerHTML="<p>No related anime found.</p>"));const s=`#/details-${a}`;if(window.location.hash===s){n.innerHTML="";for(const a of e){if(window.location.hash!==s)return;const e=document.createElement("div");e.className="relation-group";const i=document.createElement("h2");i.className="floating-header",i.textContent=a.relation,e.appendChild(i);const t=document.createElement("div");t.className="gridGallery",t.style.justifyContent="none",e.appendChild(t),n.appendChild(e);for(const e of a.entry){let a="";if("anime"===e.type)try{if(window.location.hash!==s)return;const n=await getAnimeInfo(e.mal_id);a=n?createFlashcard(n,"top-rated"):createFallbackCard(e)}catch(n){if(console.error(`Failed to fetch info for anime ID: ${e.mal_id}`,n),window.location.hash!==s)return;a=createFallbackCard(e)}else a=createFallbackCard(e);if(window.location.hash!==s)return;t.insertAdjacentHTML("beforeend",a)}}initFlashcardHover()}}function createFallbackCard(e){return`\n    <a href="${e.url}" target="_blank" class="relation-card-fallback">\n      <span class="relation-card-title">${e.name}</span>\n      <span class="relation-card-type">${e.type}</span>\n    </a>\n  `}function initDetailsNav(){const e=document.querySelectorAll(".details-nav-item"),a=document.querySelectorAll(".details-section");e.forEach(n=>{n.addEventListener("click",()=>{e.forEach(e=>e.classList.remove("active")),a.forEach(e=>e.classList.remove("active")),n.classList.add("active");const s=n.getAttribute("data-target"),i=document.getElementById(s);i&&i.classList.add("active")})})}async function loadCharecters(e){const a=`#/details-${e}`;let n=null;try{n=await getAnimeCharacters(e)}catch(e){console.error("Failed to load characters:",e)}if(window.location.hash!==a)return;const s=document.getElementById("characters");s&&(s.innerHTML=n&&n.length>0?`<div class="character-grid">${n.map(e=>{const a=e.character.images.webp.image_url;return`\n      <div class="character-card">\n          ${a.includes("questionmark")?'<div class="placeholder-icon"><i class="fas fa-user"></i></div>':`<img src="${a}" loading="lazy" alt="${e.character.name}">`}\n          <div class="character-info">\n              <h5>${e.character.name}</h5>\n              <p>${e.role}</p>\n              ${e.voice_actors&&e.voice_actors.length>0?`<p class="voice-actor"><b>Voice Actor:</b> ${e.voice_actors[0].person.name} (${e.voice_actors[0].language})</p>`:""}\n          </div>\n      </div>`}).join("")}</div>`:"<p>No character information available.</p>")}async function loadStaff(e){const a=`#/details-${e}`;let n=null;try{n=await getAnimeStaff(e)}catch(e){console.error("Failed to load staff:",e)}if(window.location.hash!==a)return;const s=document.getElementById("staff");s&&(s.innerHTML=n&&n.length>0?`<div class="staff-grid">${n.map(e=>{const a=e.person.images.jpg.image_url;return`\n       <div class="staff-card">\n           ${a.includes("questionmark")?'<div class="placeholder-icon"><i class="fas fa-user-tie"></i></div>':`<img src="${a}" loading="lazy" alt="${e.person.name}">`}\n           <div class="staff-info">\n               <h5>${e.person.name}</h5>\n               <p>${e.positions.join(", ")}</p>\n           </div>\n       </div>`}).join("")}</div>`:"<p>No staff information available.</p>")}async function loadReviews(e){const a=`#/details-${e}`,n=document.querySelector(".reviews-container"),s=document.createElement("div"),i=document.getElementById("reviews-loader");s.className="horizontal-gallery";try{const t=await getAnimeReviews(e);if(window.location.hash!==a)return;if(!t||0===t.length)return i&&i.remove(),void(n.innerHTML+='<p style="text-align: center; color: var(--text-color); padding: 2rem;">No reviews available.</p>');const l=t.map(e=>createReviewCard(e)).join("");s.innerHTML=l,n.appendChild(s),initGalleryControls(),initReviewsStuff()}catch(e){if(console.error("Failed to load reviews:",e),window.location.hash!==a)return;n.innerHTML+='<p style="text-align: center; color: var(--error-color); padding: 2rem;">Failed to load reviews.</p>'}finally{window.location.hash===a&&i&&i.remove()}}function createReviewCard(e){const a=e.score||0,n=e.user?.username||"Anonymous",s=e.mal_id||"N/A",i=e.review||"Prolly nothing important",t=i.length<300?i:i.substring(0,300)+"...";return`\n    <div class="review-card" data-full-text="${escapeHTML(i)}" data-score="${a}" data-username="${n}">\n      <div class="review-quote-icon">\n        <i class="fas fa-quote-left"></i>\n      </div>\n      <div class="review-content">\n        <p class="review-text">${escapeHTML(t)}</p>\n      </div>\n      <div class="review-footer">\n        <div class="review-user">\n          <div class="review-avatar">\n            <i class="fas fa-user-circle"></i>\n          </div>\n          <div class="review-user-info">\n            <span class="review-username">${n}</span>\n            <span class="review-mal-id">MyAnimeList ID: ${s}</span>\n          </div>\n        </div>\n        <div class="review-rating">\n          <i class="fas fa-star"></i>\n          <span class="review-score">${a}</span>\n        </div>\n      </div>\n    </div>\n  `}function initReviewsStuff(){const e=document.querySelectorAll(".review-card");function a(e){console.log("showing icon");const a=document.createElement("div");a.className="review-icon",a.innerHTML='\n      <i class="fa-solid fa-book-open"></i>\n      <p>Read More</p>\n    ',e.appendChild(a)}function n(e){console.log("removing icon");const a=e.querySelector(".review-icon");a&&a.remove()}console.log(e),e.forEach(e=>{e.addEventListener("mouseenter",()=>{a(e)}),e.addEventListener("mouseleave",()=>{n(e)}),e.addEventListener("touchstart",()=>{a(e)}),e.addEventListener("touchend",()=>{n(e)}),e.addEventListener("click",()=>{!function(e){console.log("showing revview popup");const a=document.getElementById("popup"),n=e.dataset.fullText,s=e.dataset.username,i=e.dataset.score;a.style.zIndex="999";const t=document.createElement("div");t.id="popup-content",t.innerHTML=`\n      <button id='popup-close'>x</button>\n      <h3>${s} - ${i}<i class="fas fa-star"></i></h3>\n      <p>${n}</p>\n    `,a.appendChild(t),a.addEventListener("click",e=>{e.target===a&&(a.style.zIndex="-10",a.innerHTML="")}),document.getElementById("popup-close").addEventListener("click",()=>{a.style.zIndex="-10",a.innerHTML=""})}(e)})})}